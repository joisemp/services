{% extends 'sidebar_base.html' %}

{% load static %}

{% block title %}Purchase Request Details - Issue Management{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'styles/issue_management/issue_detail/style.css' %}">
{% endblock %}

{% block navbar %}
{% include 'navbar.html' %}
{% endblock %}

{% block sidebar %}
{% include 'central_admin/sidebar.html' %}
{% endblock %}

{% block content %}

<a href="{% url 'issue_management:central_admin:purchase_request_list' %}" class="btn btn-sm btn-dark mb-3">
  <i class="fas fa-arrow-left me-2"></i>Back to Purchase Requests
</a>

<section id="breadcrumb" class="mb-3">
  <span class="badge 
               {% if purchase_request.status == 'pending' %}bg-warning text-dark
               {% elif purchase_request.status == 'approved' %}bg-success
               {% elif purchase_request.status == 'rejected' %}bg-danger
               {% endif %} rounded-pill">
    {{ purchase_request.get_status_display }}
  </span>
  <span class="badge rounded-pill text-bg-dark ms-2">{{ purchase_request.requested_at|date:"M d, Y" }}</span>
</section>

<!-- Purchase Request Details -->
<section id="purchase-request-details" class="mb-4">
  <div class="card">
    <div class="card-header">
      <h4 class="mb-0">
        <i class="fas fa-shopping-cart me-2"></i>
        {{ purchase_request.item }}
        <span class="badge bg-secondary ms-2">Qty: {{ purchase_request.quantity }}</span>
      </h4>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        {% if purchase_request.estimated_amount %}
        <div class="col-md-6">
          <h6 class="text-muted">Estimated Amount</h6>
          <p class="fs-4 text-success mb-0"><strong>${{ purchase_request.estimated_amount }}</strong></p>
        </div>
        <div class="col-md-6">
          <h6 class="text-muted">Status</h6>
          <span class="badge 
                       {% if purchase_request.status == 'pending' %}bg-warning text-dark
                       {% elif purchase_request.status == 'approved' %}bg-success
                       {% elif purchase_request.status == 'rejected' %}bg-danger
                       {% endif %} fs-6">
            {{ purchase_request.get_status_display }}
          </span>
        </div>
        {% else %}
        <div class="col-12">
          <h6 class="text-muted">Status</h6>
          <span class="badge 
                       {% if purchase_request.status == 'pending' %}bg-warning text-dark
                       {% elif purchase_request.status == 'approved' %}bg-success
                       {% elif purchase_request.status == 'rejected' %}bg-danger
                       {% endif %} fs-6">
            {{ purchase_request.get_status_display }}
          </span>
        </div>
        {% endif %}
      </div>

      <hr>

      <div class="row mb-3">
        <div class="col-md-6">
          <h6 class="text-muted">Item</h6>
          <p class="mb-0">{{ purchase_request.item }}</p>
        </div>
        <div class="col-md-6">
          <h6 class="text-muted">Quantity</h6>
          <p class="mb-0">{{ purchase_request.quantity }} unit{{ purchase_request.quantity|pluralize }}</p>
        </div>
      </div>

      {% if purchase_request.description %}
      <div class="mb-3">
        <h6 class="text-muted">Description</h6>
        <p class="mb-0">{{ purchase_request.description|linebreaksbr }}</p>
      </div>
      <hr>
      {% endif %}

      <hr>

      <div class="row">
        <div class="col-md-6 mb-3">
          <h6 class="text-muted">Requested By</h6>
          <p class="mb-0">
            <strong>{{ purchase_request.requested_by.get_full_name }}</strong>
            <br>
            <small class="text-muted">{{ purchase_request.requested_by.email }}</small>
            {% if purchase_request.requested_by.phone_number %}
            <br>
            <small class="text-muted">{{ purchase_request.requested_by.phone_number }}</small>
            {% endif %}
          </p>
        </div>
        <div class="col-md-6 mb-3">
          <h6 class="text-muted">Requested Date</h6>
          <p class="mb-0">{{ purchase_request.requested_at|date:"F d, Y" }} at {{ purchase_request.requested_at|time:"g:i A" }}</p>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <h6 class="text-muted">Space</h6>
          <p class="mb-0">
            {% if purchase_request.space %}
              {{ purchase_request.space.name }}
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </p>
        </div>
      </div>

      {% if purchase_request.reviewed_by %}
      <hr>
      <div class="alert 
                  {% if purchase_request.status == 'approved' %}alert-success
                  {% elif purchase_request.status == 'rejected' %}alert-danger
                  {% endif %}">
        <h6 class="alert-heading">
          {% if purchase_request.status == 'approved' %}
            <i class="fas fa-check-circle me-2"></i>Approved
          {% else %}
            <i class="fas fa-times-circle me-2"></i>Rejected
          {% endif %}
        </h6>
        <p class="mb-2">
          <strong>Reviewed by:</strong> {{ purchase_request.reviewed_by.get_full_name }}
          <br>
          <strong>Review date:</strong> {{ purchase_request.reviewed_at|date:"F d, Y" }} at {{ purchase_request.reviewed_at|time:"g:i A" }}
        </p>
        {% if purchase_request.review_notes %}
        <hr>
        <p class="mb-0">
          <strong>Notes:</strong><br>
          {{ purchase_request.review_notes|linebreaksbr }}
        </p>
        {% endif %}
      </div>
      {% endif %}
    </div>

    {% if purchase_request.status == 'pending' %}
    <div class="card-footer">
      <div class="d-flex gap-2 justify-content-between align-items-center">
        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
          <i class="fas fa-trash me-2"></i>Delete
        </button>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal">
            <i class="fas fa-times me-2"></i>Reject
          </button>
          <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal">
            <i class="fas fa-check me-2"></i>Approve
          </button>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</section>

<!-- Related Issue -->
<section id="related-issue" class="mb-4">
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-link me-2"></i>
        Related Issue
      </h5>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h5 class="mb-2">
            <a href="{% url 'issue_management:central_admin:issue_detail' issue_slug=purchase_request.issue.slug %}" 
               class="text-decoration-none">
              {{ purchase_request.issue.title }}
            </a>
          </h5>
          <div class="mb-2">
            <span class="badge badge-{{ purchase_request.issue.status }} rounded-pill me-1">{{ purchase_request.issue.get_status_display }}</span>
            <span class="badge badge-{{ purchase_request.issue.priority }} rounded-pill">{{ purchase_request.issue.get_priority_display }}</span>
          </div>
          <p class="text-muted mb-2">{{ purchase_request.issue.description|truncatewords:50 }}</p>
          <small class="text-muted">
            Reported by {{ purchase_request.issue.reporter.get_full_name }} on {{ purchase_request.issue.created_at|date:"M d, Y" }}
          </small>
        </div>
        {% if purchase_request.issue.images.first %}
        <div>
          <img src="{{ purchase_request.issue.images.first.image.url }}" 
               alt="Issue image" 
               class="img-thumbnail" 
               style="width: 120px; height: 120px; object-fit: cover;">
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="approveModalLabel">
          <i class="fas fa-check-circle me-2"></i>Approve Purchase Request
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'issue_management:central_admin:purchase_request_approve' purchase_request_slug=purchase_request.slug %}">
        {% csrf_token %}
        <div class="modal-body">
          <p>Are you sure you want to approve this purchase request?</p>
          <div class="mb-3">
            <label for="approve_notes" class="form-label">Approval Notes (Optional)</label>
            <textarea name="review_notes" id="approve_notes" class="form-control" rows="3" 
                      placeholder="Add any notes about this approval..."></textarea>
          </div>
          <div class="alert alert-info mb-0">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Item:</strong> {{ purchase_request.item }}<br>
            <strong>Quantity:</strong> {{ purchase_request.quantity }}
            {% if purchase_request.estimated_amount %}<br>
            <strong>Amount:</strong> ${{ purchase_request.estimated_amount }}
            {% endif %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-check me-2"></i>Approve Request
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="rejectModalLabel">
          <i class="fas fa-times-circle me-2"></i>Reject Purchase Request
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'issue_management:central_admin:purchase_request_reject' purchase_request_slug=purchase_request.slug %}">
        {% csrf_token %}
        <div class="modal-body">
          <p>Are you sure you want to reject this purchase request?</p>
          <div class="mb-3">
            <label for="reject_notes" class="form-label">Reason for Rejection <span class="text-danger">*</span></label>
            <textarea name="review_notes" id="reject_notes" class="form-control" rows="3" required
                      placeholder="Please provide a reason for rejecting this request..."></textarea>
            <small class="form-text text-muted">The reason will be visible to the space admin who created the request.</small>
          </div>
          <div class="alert alert-warning mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Item:</strong> {{ purchase_request.item }}<br>
            <strong>Quantity:</strong> {{ purchase_request.quantity }}
            {% if purchase_request.estimated_amount %}<br>
            <strong>Amount:</strong> ${{ purchase_request.estimated_amount }}
            {% endif %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-times me-2"></i>Reject Request
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">
          <i class="fas fa-trash me-2"></i>Delete Purchase Request
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'issue_management:central_admin:purchase_request_delete' purchase_request_slug=purchase_request.slug %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="alert alert-danger mb-3">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This action cannot be undone.
          </div>
          <p>Are you sure you want to delete this purchase request?</p>
          <div class="alert alert-info mb-0">
            <strong>Item:</strong> {{ purchase_request.item }}<br>
            <strong>Quantity:</strong> {{ purchase_request.quantity }}
            {% if purchase_request.estimated_amount %}<br>
            <strong>Amount:</strong> ${{ purchase_request.estimated_amount }}
            {% endif %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash me-2"></i>Delete Request
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
