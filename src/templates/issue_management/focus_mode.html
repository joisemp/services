<!DOCTYPE html>
<html lang="en">
{% load static %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Focus Mode - {{ issue.title }}</title>
    <link rel="icon" type="image/x-icon" href="{% static 'images/logo-icon.svg' %}">
    <script src="{% static 'utils/htmx/htmx.min.js' %}"></script>
    <link href="{% static 'utils/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .focus-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .focus-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .focus-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .focus-title {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
        }
        .focus-subtitle {
            opacity: 0.9;
            margin-bottom: 0;
        }
        .focus-content {
            padding: 2rem;
        }
        .issue-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .action-buttons {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        .focus-btn {
            margin-left: 0.5rem;
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .timer-display {
            font-size: 3rem;
            font-weight: 300;
            text-align: center;
            margin: 2rem 0;
            color: #1e3c72;
        }
        .progress-indicator {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        .focus-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .focus-warning {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
        }
        .comment-section {
            margin-top: 2rem;
            border-top: 1px solid #e9ecef;
            padding-top: 2rem;
        }
        .issue-details h6 {
            color: #495057;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        .issue-details .table td {
            padding: 0.375rem 0;
            border: none;
        }
        .issue-details .table td:first-child {
            width: 40%;
            color: #6c757d;
        }
        .badge {
            font-size: 0.75rem;
        }
        .issue-details img:hover {
            transform: scale(1.05);
            transition: transform 0.2s ease;
        }
    </style>
</head>

<body>
    <!-- Focus Mode Overlay (shown when trying to leave) -->
    <div class="focus-overlay" id="focusOverlay">
        <div class="focus-warning">
            <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
            <h4>Focus Mode Active</h4>
            <p class="text-muted mb-4">You are currently working on this issue. To leave focus mode, you must either pause the issue or escalate it.</p>
            <button type="button" class="btn btn-primary" onclick="hideFocusOverlay()">Continue Working</button>
        </div>
    </div>

    <!-- Django Messages -->
    {% if messages %}
        <div class="container-fluid position-fixed" style="top: 1rem; left: 50%; transform: translateX(-50%); z-index: 1050;">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="focus-container">
        <div class="focus-card">
            <div class="focus-header">
                <h1 class="focus-title">Focus Mode</h1>
                <p class="focus-subtitle">Working on: {{ issue.title }}</p>
                <div class="mt-2">
                    <span class="badge bg-warning text-dark">
                        <i class="fas fa-lock me-1"></i>
                        Navigation Locked - Focus Mode Active
                    </span>
                    <span class="badge bg-info text-white ms-2">
                        <i class="fas fa-shield-alt me-1"></i>
                        Refresh Protection: ON
                    </span>
                    <span class="badge bg-success text-white ms-2" id="sessionStatus">
                        <i class="fas fa-save me-1"></i>
                        Session Saved
                    </span>
                </div>
            </div>

            <div class="focus-content">
                <!-- Session Info -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <!-- Timer Display -->
                        <div class="timer-display" id="workTimer">00:00:00</div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-light p-3 rounded">
                            <h6 class="mb-2"><i class="fas fa-chart-line me-2"></i>Session Stats</h6>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="fw-bold text-primary">{{ current_session.work_sessions_count }}</div>
                                    <small class="text-muted">Sessions</small>
                                </div>
                                <div class="col-6">
                                    <div class="fw-bold text-success">{{ issue.total_work_time_detailed|default:"0 seconds" }}</div>
                                    <small class="text-muted">Total Work</small>
                                </div>
                            </div>
                            <div class="row text-center mt-2">
                                <div class="col-6">
                                    <div class="fw-bold text-warning">{{ issue.total_break_time_detailed|default:"0 seconds" }}</div>
                                    <small class="text-muted">Total Breaks</small>
                                </div>
                                <div class="col-6">
                                    <div class="fw-bold text-info">{{ current_session.started_at|date:"H:i" }}</div>
                                    <small class="text-muted">Started</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Indicator -->
                <div class="progress-indicator">
                    <div class="progress-bar" id="progressBar"></div>
                </div>

                <!-- Issue Details -->
                <div class="issue-details">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h4 class="mb-2">{{ issue.title }}</h4>
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <span class="badge bg-{{ issue.priority_color }}">
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ issue.get_priority_display }} Priority
                                        </span>
                                        <span class="badge bg-primary">
                                            <i class="fas fa-clock me-1"></i>{{ issue.get_status_display }}
                                        </span>
                                        {% if issue.category %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-tag me-1"></i>{{ issue.category.name }}
                                        </span>
                                        {% endif %}
                                        {% if issue.escalation_count > 0 %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-level-up-alt me-1"></i>{{ issue.escalation_count }} Escalation{{ issue.escalation_count|pluralize }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted d-block">Issue #{{ issue.id }}</small>
                                    <small class="text-muted d-block">Focus started: {{ focus_start_time|date:"H:i" }}</small>
                                </div>
                            </div>
                            
                            <!-- Full Description -->
                            <div class="mb-4">
                                <h6><i class="fas fa-file-alt me-2"></i>Description</h6>
                                <div class="bg-light p-3 rounded">
                                    {% if issue.description %}
                                        <p class="mb-0">{{ issue.description|linebreaks }}</p>
                                    {% else %}
                                        <p class="text-muted mb-0 fst-italic">No description provided</p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Issue Metadata -->
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-info-circle me-2"></i>Issue Information</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-borderless">
                                            <tr>
                                                <td><strong>Reported by:</strong></td>
                                                <td>{{ issue.created_by.profile.first_name }} {{ issue.created_by.profile.last_name }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Created:</strong></td>
                                                <td>{{ issue.created_at|date:"M d, Y H:i" }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Last updated:</strong></td>
                                                <td>{{ issue.updated_at|date:"M d, Y H:i" }}</td>
                                            </tr>
                                            {% if issue.due_date %}
                                            <tr>
                                                <td><strong>Due date:</strong></td>
                                                <td>
                                                    {{ issue.due_date|date:"M d, Y" }}
                                                    {% if issue.is_overdue %}
                                                        <span class="badge bg-danger ms-2">Overdue</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% if issue.space %}
                                            <tr>
                                                <td><strong>Space:</strong></td>
                                                <td>{{ issue.space.name }}</td>
                                            </tr>
                                            {% endif %}
                                            <tr>
                                                <td><strong>Organization:</strong></td>
                                                <td>{{ issue.org.name }}</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <!-- Issue Images -->
                                    {% if issue.images.all %}
                                    <h6><i class="fas fa-images me-2"></i>Attached Images</h6>
                                    <div class="row g-2 mb-3">
                                        {% for image in issue.images.all %}
                                        <div class="col-6">
                                            <img src="{{ image.image.url }}" class="img-fluid rounded shadow-sm" 
                                                 style="height: 100px; object-fit: cover; width: 100%; cursor: pointer;"
                                                 onclick="showImageModal('{{ image.image.url }}')"
                                                 alt="Issue attachment">
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Voice Recording -->
                                    {% if issue.voice %}
                                    <h6><i class="fas fa-microphone me-2"></i>Voice Recording</h6>
                                    <audio controls class="w-100 mb-3">
                                        <source src="{{ issue.voice.url }}" type="audio/mpeg">
                                        Your browser does not support the audio element.
                                    </audio>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Quick Actions</h5>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCommentModal">
                                <i class="fas fa-comment me-2"></i>Add Progress Note
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="takeBreak()">
                                <i class="fas fa-coffee me-2"></i>Take Break
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="viewFullIssue()" disabled>
                                <i class="fas fa-eye me-2"></i>Full Details Shown Above
                                <small class="d-block text-muted">(All details are visible in focus mode)</small>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Recent Comments <small class="text-muted">({{ issue.comments.count }} total)</small></h5>
                        <div id="recent-comments" style="max-height: 200px; overflow-y: auto;">
                            {% for comment in recent_comments %}
                            <div class="border-bottom pb-2 mb-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <small class="text-muted">{{ comment.created_at|date:"M d, H:i" }} - {{ comment.author.profile.first_name }}</small>
                                    {% if comment.is_internal %}
                                        <span class="badge bg-warning text-dark" style="font-size: 0.6rem;">Internal</span>
                                    {% endif %}
                                </div>
                                <p class="mb-0 small">{{ comment.content|truncatewords:25 }}</p>
                            </div>
                            {% empty %}
                            <p class="text-muted small">No recent comments</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Action Buttons -->
    <div class="action-buttons">
        <button type="button" class="btn btn-warning focus-btn" data-bs-toggle="modal" data-bs-target="#pauseModal">
            <i class="fas fa-pause me-2"></i>Pause Work
        </button>
        <button type="button" class="btn btn-danger focus-btn" onclick="escalateIssue()">
            <i class="fas fa-level-up-alt me-2"></i>Escalate Issue
        </button>
        <button type="button" class="btn btn-success focus-btn" data-bs-toggle="modal" data-bs-target="#resolveModal">
            <i class="fas fa-check me-2"></i>Mark Resolved
        </button>
    </div>

    <!-- Pause Work Modal -->
    <div class="modal fade" id="pauseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pause Work</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" action="{% url 'issue_management:change_status_with_comment' issue.slug 'open' %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p>You're about to pause work on this issue. Add a note about your current progress:</p>
                        <textarea name="comment" class="form-control" rows="4" placeholder="Current progress, blockers, next steps..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Pause Work</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Resolve Issue Modal -->
    <div class="modal fade" id="resolveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mark Issue as Resolved</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" action="{% url 'issue_management:change_status_with_comment' issue.slug 'resolved' %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p>Describe how you resolved this issue:</p>
                        <textarea name="comment" class="form-control" rows="4" placeholder="Solution implemented, steps taken, resolution details..." required></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Mark as Resolved</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

                <!-- Add Comment Modal -->
    <div class="modal fade" id="addCommentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Progress Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form hx-post="{% url 'issue_management:add_progress_note' issue.slug %}" 
                      hx-target="#recent-comments" 
                      hx-swap="outerHTML">
                    {% csrf_token %}
                    <div class="modal-body">
                        <textarea name="content" class="form-control" rows="4" placeholder="Progress update, findings, blockers..." required></textarea>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" name="is_internal" id="internalComment">
                            <label class="form-check-label" for="internalComment">
                                Internal note (visible to maintainers and admins only)
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Note</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Issue Attachment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" class="img-fluid" alt="Issue attachment">
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'utils/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script>
        // Focus Mode Management with Timer Persistence
        let focusStartTime = new Date();
        let workTimer;
        let secondsElapsed = 0;
        let isOnBreak = false;
        const sessionKey = 'focus_session_{{ issue.slug }}';
        
        // Initialize timer with persistence
        function initializeTimer() {
            const savedSession = localStorage.getItem(sessionKey);
            if (savedSession) {
                const sessionData = JSON.parse(savedSession);
                focusStartTime = new Date(sessionData.startTime);
                const now = new Date();
                secondsElapsed = Math.floor((now - focusStartTime) / 1000);
                
                // Validate session (not older than 24 hours)
                if (secondsElapsed < 86400) {
                    updateTimerDisplay();
                    updateProgressBar();
                } else {
                    // Reset if too old
                    resetSession();
                }
            } else {
                // Save new session
                saveSession();
            }
        }
        
        function saveSession() {
            const sessionData = {
                startTime: focusStartTime.toISOString(),
                issueSlug: '{{ issue.slug }}',
                lastActive: new Date().toISOString()
            };
            localStorage.setItem(sessionKey, JSON.stringify(sessionData));
            
            // Update session status indicator
            const statusBadge = document.getElementById('sessionStatus');
            if (statusBadge) {
                statusBadge.innerHTML = '<i class="fas fa-check me-1"></i>Session Saved';
                statusBadge.className = 'badge bg-success text-white ms-2';
                
                // Flash the badge to show it was updated
                setTimeout(() => {
                    statusBadge.style.opacity = '0.5';
                    setTimeout(() => {
                        statusBadge.style.opacity = '1';
                    }, 200);
                }, 100);
            }
        }
        
        function resetSession() {
            localStorage.removeItem(sessionKey);
            focusStartTime = new Date();
            secondsElapsed = 0;
            saveSession();
        }
        
        function endSession() {
            localStorage.removeItem(sessionKey);
        }

        // Enhanced page refresh prevention
        let refreshAttempts = 0;
        
        // Prevent navigation away from focus mode
        window.addEventListener('beforeunload', function(e) {
            if (!isOnBreak) {
                saveSession(); // Save current state
                const message = 'You are in focus mode. Leaving will pause your session. Are you sure?';
                e.returnValue = message;
                return message;
            }
        });
        
        // Detect refresh attempts and prevent them
        window.addEventListener('keydown', function(e) {
            if (isOnBreak) return;
            
            // Enhanced refresh prevention
            if ((e.key === 'F5') || (e.ctrlKey && e.key === 'r') || (e.ctrlKey && e.key === 'R')) {
                e.preventDefault();
                e.stopPropagation();
                refreshAttempts++;
                showRefreshWarning();
                return false;
            }
            
            // Prevent other navigation shortcuts
            if (e.ctrlKey && (e.key === 'w' || e.key === 'W')) {
                e.preventDefault();
                showFocusOverlay();
                return false;
            }
            
            if (e.altKey && e.key === 'F4') {
                e.preventDefault();
                showFocusOverlay();
                return false;
            }
            
            if (e.ctrlKey && (e.key === 't' || e.key === 'T' || e.key === 'n' || e.key === 'N')) {
                e.preventDefault();
                showFocusOverlay();
                return false;
            }
            
            if (e.ctrlKey && (e.key === 'l' || e.key === 'L' || e.key === 'd' || e.key === 'D')) {
                e.preventDefault();
                showFocusOverlay();
                return false;
            }
        });
        
        // Show warning for refresh attempts
        function showRefreshWarning() {
            const warningHtml = `
                <div class="alert alert-warning alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; max-width: 350px;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Focus Mode Active!</strong><br>
                    Refresh is disabled to maintain your work session. 
                    ${refreshAttempts > 1 ? `(${refreshAttempts} attempts blocked)` : ''}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Remove existing warning
            const existingWarning = document.querySelector('.refresh-warning');
            if (existingWarning) {
                existingWarning.remove();
            }
            
            // Add new warning
            const warningDiv = document.createElement('div');
            warningDiv.className = 'refresh-warning';
            warningDiv.innerHTML = warningHtml;
            document.body.appendChild(warningDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const warning = document.querySelector('.refresh-warning');
                if (warning) warning.remove();
            }, 5000);
        }

        // Start the work timer with persistence
        function startTimer() {
            workTimer = setInterval(function() {
                if (!isOnBreak) {
                    secondsElapsed++;
                    updateTimerDisplay();
                    updateProgressBar();
                    
                    // Save session every minute
                    if (secondsElapsed % 60 === 0) {
                        saveSession();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(secondsElapsed / 3600);
            const minutes = Math.floor((secondsElapsed % 3600) / 60);
            const seconds = secondsElapsed % 60;
            
            const display = 
                String(hours).padStart(2, '0') + ':' +
                String(minutes).padStart(2, '0') + ':' +
                String(seconds).padStart(2, '0');
            
            document.getElementById('workTimer').textContent = display;
        }

        function updateProgressBar() {
            // Update progress based on time worked (example: 2 hours = 100%)
            const targetSeconds = 2 * 60 * 60; // 2 hours
            const progress = Math.min((secondsElapsed / targetSeconds) * 100, 100);
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function showFocusOverlay() {
            document.getElementById('focusOverlay').style.display = 'flex';
        }

        function hideFocusOverlay() {
            document.getElementById('focusOverlay').style.display = 'none';
        }

        function takeBreak() {
            // Start break tracking
            fetch("{% url 'issue_management:start_break' issue.slug %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: 'break_type=manual'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isOnBreak = true;
                    showBreakModal();
                }
            })
            .catch(error => {
                console.error('Error starting break:', error);
                showBreakModal(); // Show modal anyway for user experience
            });
        }
        
        function showBreakModal() {
            // Show a more user-friendly break notification
            const breakModal = document.createElement('div');
            breakModal.className = 'modal fade';
            breakModal.id = 'breakModal';
            breakModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-coffee me-2"></i>Break Time
                            </h5>
                        </div>
                        <div class="modal-body text-center">
                            <div class="mb-3">
                                <i class="fas fa-clock text-info" style="font-size: 3rem;"></i>
                            </div>
                            <h4>Take a well-deserved break!</h4>
                            <p class="text-muted mb-4">Step away from your screen, stretch, hydrate, or grab a snack. Your work timer is paused.</p>
                            
                            <div class="break-timer mb-4">
                                <div class="h5 text-info" id="breakTimer">00:00</div>
                                <small class="text-muted">Break duration</small>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success btn-lg" onclick="resumeWork()">
                                    <i class="fas fa-play me-2"></i>Resume Work
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setBreakTimer(5)">
                                    <i class="fas fa-clock me-2"></i>5 min break
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setBreakTimer(15)">
                                    <i class="fas fa-clock me-2"></i>15 min break
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setBreakTimer(30)">
                                    <i class="fas fa-clock me-2"></i>30 min break
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(breakModal);
            const modal = new bootstrap.Modal(breakModal, {
                backdrop: 'static',
                keyboard: false
            });
            modal.show();
            
            // Start break timer
            startBreakTimer();
        }

        let breakStartTime;
        let breakTimer;
        let breakInterval;
        let autoResumeTimeout;

        function startBreakTimer() {
            breakStartTime = new Date();
            breakInterval = setInterval(updateBreakTimer, 1000);
        }

        function updateBreakTimer() {
            const now = new Date();
            const breakDuration = Math.floor((now - breakStartTime) / 1000);
            const minutes = Math.floor(breakDuration / 60);
            const seconds = breakDuration % 60;
            
            const display = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            const breakTimerElement = document.getElementById('breakTimer');
            if (breakTimerElement) {
                breakTimerElement.textContent = display;
            }
        }

        function setBreakTimer(minutes) {
            // Clear any existing auto-resume timeout
            if (autoResumeTimeout) {
                clearTimeout(autoResumeTimeout);
            }
            
            // Set new auto-resume timeout
            autoResumeTimeout = setTimeout(function() {
                resumeWork();
                // Show notification that break time is over
                setTimeout(function() {
                    alert('Break time is over! Welcome back to work.');
                }, 500);
            }, minutes * 60 * 1000);
            
            // Update button states to show which timer is active
            const buttons = document.querySelectorAll('#breakModal .btn-outline-secondary');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show countdown
            updateBreakCountdown(minutes * 60);
        }

        function updateBreakCountdown(totalSeconds) {
            const countdownInterval = setInterval(function() {
                totalSeconds--;
                if (totalSeconds <= 0) {
                    clearInterval(countdownInterval);
                    return;
                }
                
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const display = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
                
                const breakTimerElement = document.getElementById('breakTimer');
                if (breakTimerElement && document.getElementById('breakModal')) {
                    breakTimerElement.innerHTML = `
                        <div>${document.getElementById('breakTimer').textContent}</div>
                        <small class="text-warning">Auto-resume in: ${display}</small>
                    `;
                }
            }, 1000);
        }

        function resumeWork() {
            // End break tracking
            fetch("{% url 'issue_management:end_break' issue.slug %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Break ended. Duration:', data.break_duration);
                }
            })
            .catch(error => console.error('Error ending break:', error));
            
            isOnBreak = false;
            
            // Clear break intervals and timeouts
            if (breakInterval) {
                clearInterval(breakInterval);
            }
            if (autoResumeTimeout) {
                clearTimeout(autoResumeTimeout);
            }
            
            // Close break modal
            const breakModal = document.getElementById('breakModal');
            if (breakModal) {
                const modal = bootstrap.Modal.getInstance(breakModal);
                if (modal) {
                    modal.hide();
                }
                breakModal.remove();
            }
            
            // Show welcome back message
            const welcomeAlert = document.createElement('div');
            welcomeAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            welcomeAlert.style.cssText = 'top: 1rem; right: 1rem; z-index: 1060; max-width: 300px;';
            welcomeAlert.innerHTML = `
                <i class="fas fa-play me-2"></i>Welcome back! Work timer resumed.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(welcomeAlert);
            
            // Auto-remove welcome message after 3 seconds
            setTimeout(function() {
                if (welcomeAlert.parentNode) {
                    welcomeAlert.remove();
                }
            }, 3000);
        }

        function escalateIssue() {
            // End work session before escalating
            endWorkSession().then(() => {
                window.location.href = '{% url "issue_management:escalate_issue" issue.slug %}';
            });
        }
        
        function endWorkSession() {
            // Clear the saved session when ending work
            endSession();
            
            return fetch("{% url 'issue_management:end_work_session' issue.slug %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Work session ended. Total work time:', data.work_time);
                    console.log('Total break time:', data.break_time);
                }
                return data;
            })
            .catch(error => {
                console.error('Error ending work session:', error);
                return { success: false };
            });
        }

        function viewFullIssue() {
            // Block this action in focus mode
            showFocusOverlay();
        }

        function showImageModal(imageUrl) {
            // Allow viewing images without leaving focus mode
            document.getElementById('modalImage').src = imageUrl;
            const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            imageModal.show();
        }

        // Initialize timer when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize timer with persistence
            initializeTimer();
            startTimer();
            
            // Block back button and navigation attempts
            window.addEventListener('popstate', function(e) {
                if (!isOnBreak) {
                    showFocusOverlay();
                    history.pushState(null, null, location.href);
                }
            });

            // Push initial state to prevent back navigation
            history.pushState(null, null, location.href);

            // Disable right-click context menu in focus mode
            document.addEventListener('contextmenu', function(e) {
                if (!isOnBreak) {
                    e.preventDefault();
                }
            });
            
            // Auto-save progress every 5 minutes
            setInterval(function() {
                if (!isOnBreak) {
                    saveSession();
                    console.log('Auto-save checkpoint: ' + secondsElapsed + ' seconds worked');
                }
            }, 5 * 60 * 1000);
            
            // Save session on page visibility change
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && !isOnBreak) {
                    saveSession();
                }
            });
        });

        // Handle form submissions to allow legitimate navigation
        document.addEventListener('submit', function(e) {
            const form = e.target;
            
            // Only allow specific forms to proceed
            if (form.action.includes('change-status')) {
                e.preventDefault(); // Prevent immediate submission
                
                // End work session first
                endWorkSession().then(() => {
                    // Allow pause/resolve actions - completely disable focus mode restrictions
                    isOnBreak = true;
                    
                    // Remove all event listeners to allow normal navigation
                    window.removeEventListener('beforeunload', arguments.callee);
                    window.removeEventListener('popstate', arguments.callee);
                    document.removeEventListener('keydown', arguments.callee);
                    
                    // Submit the form
                    form.submit();
                });
                
                return false;
            }
            
            // For HTMX forms (like progress notes), prevent default navigation
            if (form.hasAttribute('hx-post')) {
                // This will be handled by HTMX, don't change focus mode state
                return true;
            }
            
            // Block all other form submissions
            e.preventDefault();
            showFocusOverlay();
            return false;
        });

        // Handle HTMX events for progress notes
        document.body.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.successful) {
                // Check if this was a progress note submission
                if (event.target.closest('#addCommentModal')) {
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addCommentModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Clear the form
                    const textarea = event.target.querySelector('textarea[name="content"]');
                    const checkbox = event.target.querySelector('input[name="is_internal"]');
                    if (textarea) textarea.value = '';
                    if (checkbox) checkbox.checked = false;
                    
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    successAlert.style.cssText = 'top: 1rem; right: 1rem; z-index: 1060; max-width: 300px;';
                    successAlert.innerHTML = `
                        <i class="fas fa-check me-2"></i>Progress note added successfully!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(successAlert);
                    
                    // Auto-remove success message after 3 seconds
                    setTimeout(function() {
                        if (successAlert.parentNode) {
                            successAlert.remove();
                        }
                    }, 3000);
                }
            }
        });

        // Block all attempts to navigate away while in focus mode
        document.addEventListener('click', function(e) {
            const target = e.target.closest('a');
            if (target && target.href && !isOnBreak) {
                // Allow only specific actions
                const allowedActions = [
                    'escalate_issue',
                    'change_status_with_comment'
                ];
                
                const isAllowed = allowedActions.some(action => target.href.includes(action));
                
                if (!isAllowed) {
                    e.preventDefault();
                    showFocusOverlay();
                    return false;
                }
            }
        });
    </script>
</body>
</html>
