{% extends 'sidebar_base.html' %}
{% load static %}

{% block title %}{{ issue.title }}{% endblock title %}

{% block style %}
<link rel="stylesheet" href="{% static 'styles/issue_management/issue_list/style.css' %}">
<style>
    .issue-header {
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    .status-badge {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
    }
    .priority-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    .comment-card {
        border-left: 3px solid #007bff;
        margin-bottom: 1rem;
    }
    .internal-comment {
        border-left-color: #ffc107;
        background-color: #fff8e1;
    }
    .activity-item {
        border-left: 2px solid #e5e7eb;
        padding-left: 1rem;
        margin-bottom: 1rem;
    }
    .overdue {
        color: #dc3545;
        font-weight: bold;
    }
</style>
{% endblock style %}

{% block content %}
<div class="container-fluid">
    <!-- Issue Header -->
    <div class="issue-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2 class="mb-2">{{ issue.title }}</h2>
                <div class="d-flex gap-2 mb-2">
                    <span class="badge bg-{{ issue.status_color }} status-badge">
                        {{ issue.get_status_display }}
                    </span>
                    <span class="badge bg-{{ issue.priority_color }} priority-badge">
                        {{ issue.get_priority_display }} Priority
                    </span>
                    {% if issue.category %}
                        <span class="badge" style="background-color: {{ issue.category.color }}; color: white;">
                            {{ issue.category.name }}
                        </span>
                    {% endif %}
                    {% if issue.is_overdue %}
                        <span class="badge bg-danger">
                            <i class="fas fa-clock"></i> Overdue
                        </span>
                    {% endif %}
                </div>
                <div class="text-muted small">
                    <i class="fas fa-user"></i> Reported by 
                    {% if issue.created_by %}
                        {{ issue.created_by.profile.first_name }} {{ issue.created_by.profile.last_name }}
                    {% else %}
                        Unknown
                    {% endif %}
                    on {{ issue.created_at|date:"M d, Y \a\\t g:i A" }}
                    {% if issue.space %}
                        <span class="ms-2">
                            <i class="fas fa-building"></i> {{ issue.space.name }}
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="text-end">
                {% if can_edit %}
                    <a href="{% url 'issue_management:update_issue' issue.slug %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i> Update Issue
                    </a>
                {% endif %}
                {% if user.profile.user_type == 'central_admin' %}
                    <a href="{% url 'issue_management:assign_issue' issue.slug %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-user-plus"></i> 
                        {% if issue.maintainer %}Change{% else %}Assign{% endif %} Maintainer
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Issue Description -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Description</h5>
                    <p>{{ issue.description|linebreaks }}</p>
                    
                    <!-- Images -->
                    {% if issue.images.all %}
                        <div class="mt-3">
                            <h6>Attached Images</h6>
                            <div class="d-flex flex-wrap gap-2">
                                {% for img in issue.images.all %}
                                    <img src="{{ img.image.url }}" 
                                         alt="Issue Image" 
                                         class="img-thumbnail" 
                                         style="width:120px;height:120px;object-fit:cover;cursor:pointer;" 
                                         onclick="showImagePreview('{{ img.image.url }}')" />
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Voice Recording -->
                    {% if issue.voice %}
                        <div class="mt-3">
                            <h6>Voice Recording</h6>
                            <audio controls class="w-100">
                                <source src="{{ issue.voice.url }}">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Resolution Notes -->
            {% if issue.resolution_notes %}
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-success">
                            <i class="fas fa-check-circle"></i> Resolution
                        </h5>
                        <p>{{ issue.resolution_notes|linebreaks }}</p>
                        {% if issue.resolved_at %}
                            <small class="text-muted">
                                Resolved on {{ issue.resolved_at|date:"M d, Y \a\\t g:i A" }}
                            </small>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Comments Section -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments"></i> Comments ({{ comments.count }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if comments %}
                        {% for comment in comments %}
                            <div class="comment-card card p-3 {% if comment.is_internal %}internal-comment{% endif %}">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>{{ comment.author.profile.first_name }} {{ comment.author.profile.last_name }}</strong>
                                        {% if comment.is_internal %}
                                            <span class="badge bg-warning ms-2">Internal</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">{{ comment.created_at|date:"M d, Y \a\\t g:i A" }}</small>
                                </div>
                                <div class="mt-2">{{ comment.content|linebreaks }}</div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No comments yet.</p>
                    {% endif %}

                    <!-- Add Comment Form -->
                    {% if can_comment and comment_form %}
                        <div class="mt-4">
                            <h6>Add Comment</h6>
                            <form method="post">
                                {% csrf_token %}
                                <div class="mb-3">
                                    {{ comment_form.content }}
                                </div>
                                {% if user.profile.user_type in 'maintainer,central_admin' %}
                                    <div class="form-check mb-3">
                                        {{ comment_form.is_internal }}
                                        <label class="form-check-label" for="{{ comment_form.is_internal.id_for_label }}">
                                            Internal comment (visible only to maintainers and admins)
                                        </label>
                                    </div>
                                {% endif %}
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-comment"></i> Add Comment
                                </button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Details Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Issue Details</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-5"><strong>Status:</strong></div>
                        <div class="col-7">
                            <span class="badge bg-{{ issue.status_color }}">
                                {{ issue.get_status_display }}
                            </span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-5"><strong>Priority:</strong></div>
                        <div class="col-7">
                            <span class="badge bg-{{ issue.priority_color }}">
                                {{ issue.get_priority_display }}
                            </span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-5"><strong>Assignee:</strong></div>
                        <div class="col-7">
                            {% if issue.maintainer %}
                                {{ issue.maintainer.profile.first_name }} {{ issue.maintainer.profile.last_name }}
                            {% else %}
                                <em class="text-muted">Unassigned</em>
                            {% endif %}
                        </div>
                    </div>
                    {% if issue.due_date %}
                        <div class="row mb-2">
                            <div class="col-5"><strong>Due Date:</strong></div>
                            <div class="col-7 {% if issue.is_overdue %}overdue{% endif %}">
                                {{ issue.due_date|date:"M d, Y" }}
                                {% if issue.is_overdue %}
                                    <br><small>Overdue!</small>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    <div class="row mb-2">
                        <div class="col-5"><strong>Created:</strong></div>
                        <div class="col-7">{{ issue.created_at|date:"M d, Y" }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-5"><strong>Updated:</strong></div>
                        <div class="col-7">{{ issue.updated_at|date:"M d, Y" }}</div>
                    </div>
                </div>
            </div>

            <!-- Activity History -->
            {% if status_history %}
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Activity History</h6>
                    </div>
                    <div class="card-body">
                        {% for history in status_history %}
                            <div class="activity-item">
                                <div class="small">
                                    <strong>{{ history.changed_by.profile.first_name }} {{ history.changed_by.profile.last_name }}</strong>
                                    {% if history.old_status != history.new_status %}
                                        changed status from <strong>{{ history.get_old_status_display }}</strong> to <strong>{{ history.get_new_status_display }}</strong>
                                    {% elif history.old_maintainer != history.new_maintainer %}
                                        {% if history.new_maintainer %}
                                            assigned to <strong>{{ history.new_maintainer.profile.first_name }} {{ history.new_maintainer.profile.last_name }}</strong>
                                        {% else %}
                                            unassigned the issue
                                        {% endif %}
                                    {% elif history.old_priority != history.new_priority %}
                                        changed priority from <strong>{{ history.get_old_priority_display }}</strong> to <strong>{{ history.get_new_priority_display }}</strong>
                                    {% endif %}
                                    <div class="text-muted">{{ history.created_at|date:"M d, Y \a\\t g:i A" }}</div>
                                    {% if history.comment %}
                                        <div class="mt-1">{{ history.comment }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Back Button -->
    <div class="text-center mt-4">
        <a href="{% url 'issue_management:issue_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Issues
        </a>
    </div>
</div>

<!-- Image Preview Modal (same as in issue_list.html) -->
<div id="imagePreviewOverlay" onclick="hideImagePreview()" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.85);z-index:9999;justify-content:center;align-items:center;">
    <img id="imagePreviewFull" src="" alt="Full Preview" style="max-width:96vw;max-height:96vh;border-radius:12px;"/>
    <button onclick="hideImagePreview()" class="btn btn-light position-absolute top-0 end-0 m-3" style="font-size:1.5rem;">&times;</button>
</div>
{% endblock content %}

{% block scripts %}
<script>
function showImagePreview(url) {
    const overlay = document.getElementById('imagePreviewOverlay');
    const img = document.getElementById('imagePreviewFull');
    img.src = url;
    overlay.style.display = 'flex';
}

function hideImagePreview() {
    document.getElementById('imagePreviewOverlay').style.display = 'none';
}
</script>
{% endblock scripts %}
