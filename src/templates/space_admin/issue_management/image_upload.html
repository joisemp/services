{% extends 'sidebar_base.html' %}

{% load static %}

{% block title %}Upload Additional Images{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'styles/issue_management/forms/style.css' %}">
<style>
    .drop-zone {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background-color: #f8f9fa;
    }

    .drop-zone:hover {
        border-color: #007bff;
        background-color: #e3f2fd;
    }

    .drop-zone.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
        transform: scale(1.02);
    }

    .file-preview {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
    }

    .preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 20px;
    }

    .preview-item {
        position: relative;
        margin-right: 8px;
        margin-bottom: 8px;
    }

    .preview-item .remove-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        line-height: 1;
        cursor: pointer;
        transform: translate(25%, -25%);
    }
</style>
{% endblock %}

{% block navbar %}
{% include 'navbar.html' %}
{% endblock %}

{% block sidebar %}
{% include 'space_admin/sidebar.html' %}
{% endblock %}

{% block content %}


<section id="upload-header" class="mb-4">

    <a href="{% url 'issue_management:space_admin:issue_detail' issue_slug=issue.slug %}"
        class="btn btn-outline-secondary">
        <span class="material-symbols-outlined me-2 align-text-bottom">arrow_back</span>Back to Issue
    </a>

</section>

<section id="upload-form" class="mb-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <span class="material-symbols-outlined me-2 align-text-bottom">image</span>Select Images to Upload
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="image-upload-form">
                        {% csrf_token %}

                        <!-- Drag and Drop Zone -->
                        <div class="drop-zone" id="drop-zone">
                            <div class="drop-zone-content">
                                <span class="material-symbols-outlined" style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem; display: block;">cloud_upload</span>
                                <h5 class="text-muted">Drag and drop images here</h5>
                                <p class="text-muted mb-3">or</p>
                                <button type="button" class="btn btn-primary"
                                    onclick="document.getElementById('{{ form.images.id_for_label }}').click()">
                                    <span class="material-symbols-outlined me-2 align-text-bottom">folder_open</span>Browse Files
                                </button>
                            </div>
                        </div>

                        <!-- Hidden File Input -->
                        {{ form.images }}

                        <!-- Preview Area -->
                        <div id="preview-area" class="preview-container" style="display: none;">
                            <h6 class="mt-3 mb-2">Selected Images:</h6>
                            <div id="image-previews"></div>
                        </div>

                        <!-- Form Errors -->
                        {% if form.errors %}
                        <div class="alert alert-danger mt-3">
                            <h6 class="alert-heading">Please correct the following errors:</h6>
                            {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                            <p class="mb-0"><strong>{{ field|title }}:</strong> {{ error }}</p>
                            {% endfor %}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Form Help Text -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6 class="text-muted mb-2">
                                <span class="material-symbols-outlined me-2 align-text-bottom">info</span>Upload Guidelines
                            </h6>
                            <ul class="text-muted small mb-0">
                                <li>Maximum 5 images per upload</li>
                                <li>Maximum file size: 10MB per image</li>
                                <li>Supported formats: JPEG, PNG, GIF, WebP</li>
                                <li>Images will be automatically resized if necessary</li>
                            </ul>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="history.back()">
                                <span class="material-symbols-outlined me-2 align-text-bottom">close</span>Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                                <span class="material-symbols-outlined me-2 align-text-bottom">upload</span>Upload Images
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock content %}

{% block scripts %}
<script>
    let selectedFiles = [];

    document.addEventListener('DOMContentLoaded', function () {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('{{ form.images.id_for_label }}');
        const previewArea = document.getElementById('preview-area');
        const imagePreviewsContainer = document.getElementById('image-previews');
        const submitBtn = document.getElementById('submit-btn');

        // Hide the default file input
        fileInput.style.display = 'none';

        // Drag and drop handlers
        dropZone.addEventListener('dragover', function (e) {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', function (e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', function (e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');

            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        // File input change handler
        fileInput.addEventListener('change', function () {
            const files = Array.from(this.files);
            handleFiles(files);
        });

        function handleFiles(files) {
            // Filter for image files only
            const imageFiles = files.filter(file => file.type.startsWith('image/'));

            if (imageFiles.length !== files.length) {
                alert('Only image files are allowed');
            }

            // Limit to 5 files
            if (imageFiles.length > 5) {
                alert('Maximum 5 images allowed');
                return;
            }

            selectedFiles = imageFiles;
            updateFileInput();
            showPreviews();
            updateSubmitButton();
        }

        function updateFileInput() {
            // Create new FileList for the input
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            fileInput.files = dt.files;
        }

        function showPreviews() {
            imagePreviewsContainer.innerHTML = '';

            if (selectedFiles.length === 0) {
                previewArea.style.display = 'none';
                return;
            }

            previewArea.style.display = 'block';

            selectedFiles.forEach((file, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item position-relative me-2 mb-2';

                const img = document.createElement('img');
                img.className = 'file-preview img-thumbnail';
                img.src = URL.createObjectURL(file);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.onclick = () => removeFile(index);

                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);
                imagePreviewsContainer.appendChild(previewItem);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileInput();
            showPreviews();
            updateSubmitButton();
        }

        function updateSubmitButton() {
            submitBtn.disabled = selectedFiles.length === 0;
        }
    });

    function deleteImage(imageSlug, issueSlug) {
        if (confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/issues/space-admin/${issueSlug}/images/${imageSlug}/delete/`;

            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken.value;
                form.appendChild(csrfInput);
            }

            // Add form to page and submit
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock scripts %}